<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Guru - Dasbor Ujian Terpadu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Firebase v8 SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tab-btn.active {
            border-bottom-color: #2563eb;
            color: #2563eb;
            font-weight: 600;
        }
        @keyframes pulse-red {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        .status-cheating {
            animation: pulse-red 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        .ai-loader { /* Smaller loader for AI analysis */
             border-width: 3px;
             width: 20px;
             height: 20px;
             margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .delete-btn {
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .group:hover .delete-btn {
            opacity: 1;
        }
        select:disabled, input:disabled {
            background-color: #e9ecef;
            cursor: not-allowed;
        }
        #analyze-class-btn:disabled {
            background-color: #f3f4f6;
            color: #9ca3af;
            cursor: not-allowed;
        }
        .prose { max-width: none; } /* Tailwind prose override */
    </style>
</head>
<body class="bg-slate-50">

    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-sm">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Login Portal Guru</h2>
            <div class="space-y-4">
                <div>
                    <label for="teacher-id" class="block text-sm font-medium text-gray-700">ID Guru</label>
                    <input type="text" id="teacher-id" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="teacher-password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="teacher-password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            <p id="login-error" class="text-red-500 text-sm mt-4 text-center hidden">ID atau Password salah.</p>
            <button id="login-btn" class="mt-6 w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition">
                Masuk
            </button>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-sm text-center">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Konfirmasi Tindakan</h2>
            <p id="confirmation-message" class="text-gray-600 mb-6">Apakah Anda yakin ingin melanjutkan?</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-yes-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700">Ya</button>
                <button id="confirm-no-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Tidak</button>
            </div>
        </div>
    </div>

    <!-- Config Error Modal -->
    <div id="config-error-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-lg text-left">
            <h2 class="text-2xl font-bold text-red-600 mb-4">Kesalahan Konfigurasi Firebase</h2>
            <p class="text-gray-700 mb-4">
                Aplikasi ini belum terhubung ke database. Anda perlu mengganti konfigurasi Firebase placeholder di dalam kode.
            </p>
            <p class="text-gray-700 mb-6">
                Silakan ikuti langkah-langkah ini:
            </p>
            <ol class="list-decimal list-inside space-y-2 text-gray-600 mb-6">
                <li>Buka projek Firebase Anda.</li>
                <li>Pergi ke <strong>Setelan Proyek</strong> (ikon gerigi) > <strong>Umum</strong>.</li>
                <li>Di bawah "Aplikasi Anda", cari dan salin objek konfigurasi (<code>firebaseConfig</code>).</li>
                <li>Tempel objek tersebut ke dalam file <code>portal_guru.html</code> untuk menggantikan placeholder.</li>
            </ol>
            <div class="bg-slate-100 p-4 rounded-md">
                <pre class="text-xs text-gray-800 overflow-auto"><code>// Cari kode ini di dalam file portal_guru.html
const firebaseConfig = {
    apiKey: "AIzaSy...",
    authDomain: "...",
    // ...
};</code></pre>
            </div>
        </div>
    </div>

    <!-- Security Rules Error Modal -->
    <div id="security-error-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-2xl text-left">
            <h2 class="text-2xl font-bold text-red-600 mb-4">Akses Ditolak (Permission Denied)</h2>
            <p class="text-gray-700 mb-4">
                Aplikasi tidak dapat mengambil data dari Firestore karena diblokir oleh <strong>Aturan Keamanan (Security Rules)</strong> database Anda.
            </p>
            <p class="text-gray-700 mb-6">
                Untuk memperbaikinya, silakan perbarui aturan Anda di Firebase Console:
            </p>
            <ol class="list-decimal list-inside space-y-2 text-gray-600 mb-6">
                <li>Buka projek Firebase Anda dan pergi ke <strong>Firestore Database</strong>.</li>
                <li>Klik pada tab <strong>Aturan</strong>.</li>
                <li>Gantikan semua isi di editor dengan kode di bawah ini.</li>
                <li>Klik <strong>Publikasikan</strong>.</li>
            </ol>
            <div class="bg-slate-100 p-4 rounded-md">
                <pre class="text-xs text-gray-800 overflow-auto"><code>rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Aturan spesifik untuk quiz_configs
    match /quiz_configs/{classLevel} {
      allow read: if request.auth != null; // Izinkan semua pengguna terautentikasi (guru/siswa) membaca
      allow write: if request.auth != null; // Izinkan guru (diasumsikan semua pengguna terautentikasi bisa menulis)
    }
    // Aturan spesifik untuk quiz_attempts
    match /quiz_attempts/{attemptId} {
      allow read, write: if request.auth != null; // Izinkan pengguna terautentikasi (guru/siswa anonim)
    }
    // Aturan untuk koleksi lain (sesuaikan jika perlu)
    match /quiz_sessions/{sessionId} {
         allow read, write: if request.auth != null;
    }
     match /cheating_log/{logId} {
         allow read, write: if request.auth != null;
    }
    // Aturan default (jika tidak cocok di atas)
    match /{document=**} {
      allow read, write: if request.auth != null; // Sesuaikan atau hapus jika perlu
    }
  }
}</code></pre>
            </div>
             <button id="security-close-btn" class="mt-6 w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition">
                Saya Mengerti
            </button>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <header class="bg-white shadow-sm sticky top-0 z-40">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center space-x-4">
                <div class="bg-blue-600 p-2 rounded-lg">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Portal Guru</h1>
                    <p class="text-sm text-gray-500">Dasbor Ujian Terpadu</p>
                </div>
            </div>
        </header>

        <main class="container mx-auto p-4 sm:p-6 lg:p-8">
            <div class="bg-white rounded-xl shadow-lg p-6 md:p-8">
                <!-- Tab Navigation -->
                <div class="border-b border-gray-200 mb-6">
                    <nav class="-mb-px flex space-x-6 overflow-x-auto">
                        <button class="tab-btn py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 transition whitespace-nowrap" data-tab="live">Monitor Sesi Live</button>
                        <button class="tab-btn py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 transition whitespace-nowrap" data-tab="pelanggaran">Riwayat Pelanggaran</button>
                        <button class="tab-btn py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 transition whitespace-nowrap" data-tab="analisis">Analisis Jawaban</button>
                        <button class="tab-btn py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 transition whitespace-nowrap" data-tab="pengaturan">Pengaturan Kuis</button>
                    </nav>
                </div>

                <!-- Tab Content -->
                <div id="tab-content">
                    <!-- Monitor Sesi Live Content -->
                    <div id="tab-content-live" class="tab-pane">
                        <div id="live-session-monitor">
                            <div class="flex justify-between items-center mb-4">
                                <h3 id="monitor-title" class="text-xl font-semibold text-gray-800">Memantau Sesi Pengerjaan Kuis</h3>
                                <button id="reset-session-btn" class="text-sm bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition">Reset Sesi Live</button>
                            </div>
                            <div class="bg-slate-100 p-4 rounded-lg mb-4 text-center">
                                <span class="font-semibold">Jumlah Murid Mengerjakan:</span> <span id="student-count" class="font-bold text-blue-600 text-lg">0</span>
                            </div>
                            <div id="student-list" class="space-y-3">
                                <!-- Student items will be injected here -->
                            </div>
                        </div>
                    </div>

                    <!-- Riwayat Pelanggaran Content -->
                    <div id="tab-content-pelanggaran" class="tab-pane hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-gray-800">Log Pelanggaran Kuis</h3>
                            <button id="delete-all-logs-btn" class="text-sm bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition">Hapus Semua Riwayat</button>
                        </div>
                        <div id="cheating-log-list" class="space-y-3">
                            <!-- Log items will be injected here -->
                        </div>
                    </div>

                    <!-- Analisis Jawaban Content -->
                    <div id="tab-content-analisis" class="tab-pane hidden">
                         <div class="space-y-4 max-w-2xl mx-auto">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="analysis-exam-type" class="block text-sm font-medium text-gray-700">1. Pilih Tipe Jawaban</label>
                                    <select id="analysis-exam-type" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                        <option value="">-- Pilih --</option>
                                        <option value="pilihan_ganda">Pilihan Ganda</option>
                                        <option value="uraian">Uraian</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="analysis-class" class="block text-sm font-medium text-gray-700">2. Pilih Kelas</label>
                                    <select id="analysis-class" disabled class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md bg-gray-100">
                                        <option value="">-- Pilih Tipe Jawaban Dulu --</option>
                                    </select>
                                </div>
                            </div>
                            <div id="analysis-options" class="hidden text-center border-t pt-4">
                                <h3 class="text-base font-medium text-gray-700 mb-2">3. Pilih Jenis Analisis</h3>
                                <div class="inline-flex rounded-md shadow-sm">
                                    <button id="analyze-class-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-l-lg hover:bg-gray-50 focus:z-10 focus:ring-2 focus:ring-blue-500">Analisis Per Kelas</button>
                                    <button id="analyze-student-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-r-md hover:bg-gray-50 focus:z-10 focus:ring-2 focus:ring-blue-500">Analisis Per Murid</button>
                                </div>
                            </div>
                        </div>

                        <!-- Analysis Results Area -->
                        <div id="analysis-results-area" class="mt-8 border-t pt-6">
                             <p id="analysis-loading" class="hidden text-center text-gray-500">
                                 <span class="loader inline-block w-6 h-6 mr-2"></span> Memuat data analisis...
                             </p>
                            <!-- Class Analysis -->
                            <div id="class-analysis-content" class="hidden">
                                <div id="class-stats" class="grid grid-cols-2 gap-4 mb-6 text-center"></div>
                                <div class="flex justify-between items-center mb-4">
                                    <h4 class="text-lg font-semibold text-gray-800">Analisis Butir Soal</h4>
                                    <button id="ai-summary-btn" class="bg-gradient-to-r from-purple-500 to-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:opacity-90 transition flex items-center gap-2">
                                        âœ¨ Buat Ringkasan AI
                                    </button>
                                </div>
                                <div id="ai-summary-result" class="hidden p-4 bg-slate-50 rounded-lg mb-4 prose"></div>
                                <div id="question-analysis-list" class="space-y-4"></div>
                            </div>
                            <!-- Student Analysis -->
                            <div id="student-analysis-content" class="hidden">
                                <div class="max-w-md mx-auto flex items-end gap-2">
                                    <div class="flex-grow">
                                        <label for="analysis-student" class="block text-sm font-medium text-gray-700">Pilih Murid</label>
                                        <select id="analysis-student" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"></select>
                                    </div>
                                    <button id="show-student-analysis-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition">Tampilkan</button>
                                </div>
                                <div id="student-info-area" class="hidden mt-6 text-center mb-4 p-4 bg-slate-50 rounded-lg">
                                     <p>Jumlah Percobaan: <strong id="student-attempt-count" class="text-blue-600">0</strong></p>
                                     <button id="reset-attempt-btn" data-studentid="" class="mt-2 text-sm bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-1 px-3 rounded-lg transition">Reset Percobaan</button>
                                     <p id="reset-status" class="text-sm mt-1"></p>
                                </div>
                                <div id="student-detail-list" class="mt-6"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Pengaturan Kuis Content -->
                    <div id="tab-content-pengaturan" class="tab-pane hidden">
                        <h3 class="text-xl font-semibold text-gray-800 mb-6">Pengaturan Kuis per Jenjang Kelas</h3>
                        <div class="max-w-xl mx-auto space-y-4">
                             <div>
                                <label for="config-class-level" class="block text-sm font-medium text-gray-700">Pilih Jenjang Kelas</label>
                                <select id="config-class-level" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                    <option value="">-- Pilih --</option>
                                    <option value="X">Kelas X</option>
                                    <option value="XI">Kelas XI</option>
                                    <option value="XII">Kelas XII</option>
                                </select>
                            </div>

                            <div id="config-form" class="hidden space-y-4 pt-4 border-t">
                                 <div>
                                    <label for="config-num-questions" class="block text-sm font-medium text-gray-700">Jumlah Soal Ditampilkan</label>
                                    <input type="number" id="config-num-questions" min="1" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <p class="text-xs text-gray-500 mt-1">Biarkan kosong untuk menampilkan semua soal.</p>
                                </div>
                                <div class="flex items-center">
                                    <input id="config-shuffle" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                    <label for="config-shuffle" class="ml-2 block text-sm text-gray-900">Acak Urutan Soal</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="config-use-timer" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                    <label for="config-use-timer" class="ml-2 block text-sm text-gray-900">Gunakan Timer</label>
                                </div>
                                <div id="config-timer-duration-group" class="hidden">
                                     <label for="config-timer-duration" class="block text-sm font-medium text-gray-700">Durasi Timer (menit)</label>
                                     <input type="number" id="config-timer-duration" min="1" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <button id="save-config-btn" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition flex items-center justify-center">
                                     Simpan Pengaturan
                                </button>
                                <p id="config-save-status" class="text-sm mt-2 text-center"></p>
                            </div>
                             <div id="config-loader" class="hidden text-center py-6">
                                <div class="loader inline-block"></div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyBDIBFVUDSxN4Qs9HsHzvVac3NCTXBkDIg",
          authDomain: "projek-kuis-42454.firebaseapp.com",
          projectId: "projek-kuis-42454",
          storageBucket: "projek-kuis-42454.appspot.com",
          messagingSenderId: "230493914497",
          appId: "1:230493914497:web:5ea60af2c77e8f2bcd1480"
        };

        // --- Data Sources ---
        const CSV_URLS = {
            login: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQnP8COEuoPRN4A6QqHCayDqWfciL9F7CQTasp4S1m4M0JAmYdvJuDjg7D1dqlnnyiJdtuMxRFOjBPg/pub?gid=1382150609&single=true&output=csv",
            jawabanPG: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQp3k-ZbcM47ZI5vT0NGhsfnUvEiyIGpITLQiVjpdtwInRFFZEFks0XJhm-LP2H15sN12ZqQxUx0sts/pub?gid=0&single=true&output=csv",
            jawabanUraian: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQp3k-ZbcM47ZI5vT0NGhsfnUvEiyIGpITLQiVjpdtwInRFFZEFks0XJhm-LP2H15sN12ZqQxUx0sts/pub?gid=824586483&single=true&output=csv",
            soalX: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQp3k-ZbcM47ZI5vT0NGhsfnUvEiyIGpITLQiVjpdtwInRFFZEFks0XJhm-LP2H15sN12ZqQxUx0sts/pub?gid=586568774&single=true&output=csv",
            soalXI: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQp3k-ZbcM47ZI5vT0NGhsfnUvEiyIGpITLQiVjpdtwInRFFZEFks0XJhm-LP2H15sN12ZqQxUx0sts/pub?gid=397565300&single=true&output=csv",
            soalXII: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQp3k-ZbcM47ZI5vT0NGhsfnUvEiyIGpITLQiVjpdtwInRFFZEFks0XJhm-LP2H15sN12ZqQxUx0sts/pub?gid=183515394&single=true&output=csv"
        };
        const GEMINI_API_KEY = "AIzaSyA_k_QIBTPWbHp1fH2LethT3Lm_DZT7Y6c"; // API Key dimasukkan di sini

        // --- Firebase Initialization ---
        let db;

        // --- DOM Elements ---
        const loginModal = document.getElementById('login-modal');
        const loginBtn = document.getElementById('login-btn');
        const loginError = document.getElementById('login-error');
        const mainApp = document.getElementById('main-app');
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabPanes = document.querySelectorAll('.tab-pane');
        const confirmationModal = document.getElementById('confirmation-modal');
        const securityErrorModal = document.getElementById('security-error-modal');
        const configErrorModal = document.getElementById('config-error-modal');
        let confirmCallback = null;

        // --- Config Tab Elements ---
        const configClassLevelSelect = document.getElementById('config-class-level');
        const configForm = document.getElementById('config-form');
        const configNumQuestionsInput = document.getElementById('config-num-questions');
        const configShuffleCheckbox = document.getElementById('config-shuffle');
        const configUseTimerCheckbox = document.getElementById('config-use-timer');
        const configTimerDurationGroup = document.getElementById('config-timer-duration-group');
        const configTimerDurationInput = document.getElementById('config-timer-duration');
        const saveConfigBtn = document.getElementById('save-config-btn');
        const configSaveStatus = document.getElementById('config-save-status');
        const configLoader = document.getElementById('config-loader');


        // --- State Management ---
        let teacherData = [];
        let currentLiveSession = 'quiz_sessions'; // Hardcoded session name
        let liveSessionUnsubscribe = null;
        let cheatingLogUnsubscribe = null;
        let analysisData = {
            answers: [], // Holds PG or Uraian answers based on selection
            pgAnswers: [], // Cache for PG answers
            uraianAnswers: [], // Cache for Uraian answers
            questions: []
        };
        
        // --- Helper Functions ---
        const parseCSV = (text) => {
            const lines = text.trim().replace(/\r/g, '').split(/\n(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            const headerLine = lines.shift() || '';
            const regexParser = /(?:"([^"]*(?:""[^"]*)*)"|([^,]*))(,|$)/g;
            const headers = [];
            let headerMatch;
            regexParser.lastIndex = 0;
            while ((headerMatch = regexParser.exec(headerLine))) {
                let value = headerMatch[1] !== undefined ? headerMatch[1].replace(/""/g, '"') : headerMatch[2];
                headers.push(value.trim());
                if (headerMatch[3] === '') break;
            }
            
            return lines.map(line => {
                const obj = {};
                const columns = [];
                let match;
                regexParser.lastIndex = 0;
                while ((match = regexParser.exec(line))) {
                    let value = match[1] !== undefined ? match[1].replace(/""/g, '"') : match[2];
                    columns.push(value.trim());
                    if (match[3] === '') break;
                }
                headers.forEach((header, index) => {
                    obj[header] = columns[index];
                });
                return obj;
            });
        };

        const showConfirmation = (message, onConfirm) => {
            document.getElementById('confirmation-message').textContent = message;
            confirmationModal.classList.remove('hidden');
            confirmCallback = onConfirm;
        };

        // --- Login Logic ---
        async function initLogin() {
            try {
                const response = await fetch(CSV_URLS.login);
                const csvText = await response.text();
                teacherData = csvText.trim().split('\n').map(line => {
                    const [id, password] = line.split(',');
                    return { id: id.trim(), password: password.trim() };
                });
            } catch (e) {
                loginError.textContent = "Gagal memuat data login. Periksa koneksi.";
                loginError.classList.remove('hidden');
            }
        }

        loginBtn.addEventListener('click', () => {
            const id = document.getElementById('teacher-id').value;
            const password = document.getElementById('teacher-password').value;
            const teacher = teacherData.find(t => t.id === id && t.password === password);
            if (teacher) {
                loginModal.classList.add('hidden');
                mainApp.classList.remove('hidden');
                initDashboard();
            } else {
                loginError.classList.remove('hidden');
            }
        });

        // --- Dashboard & Tabs ---
        function initDashboard() {
            showTab('live'); // Default tab
            tabButtons.forEach(button => {
                button.addEventListener('click', () => showTab(button.dataset.tab));
            });
            // Pre-load PG answers for attempt count
            preloadAnswerData(); 
        }
        
        async function preloadAnswerData() {
            try {
                const pgResponse = await fetch(CSV_URLS.jawabanPG);
                const pgText = await pgResponse.text();
                analysisData.pgAnswers = parseCSV(pgText);

                const uraianResponse = await fetch(CSV_URLS.jawabanUraian);
                const uraianText = await uraianResponse.text();
                analysisData.uraianAnswers = parseCSV(uraianText);
            } catch (err) {
                console.error("Gagal memuat data jawaban awal:", err);
                // Optionally show an error message
            }
        }

        function showTab(tabId) {
            // Unsubscribe from previous listeners
            if (liveSessionUnsubscribe) liveSessionUnsubscribe();
            if (cheatingLogUnsubscribe) cheatingLogUnsubscribe();

            tabPanes.forEach(pane => pane.classList.add('hidden'));
            tabButtons.forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(`tab-content-${tabId}`).classList.remove('hidden');
            document.querySelector(`.tab-btn[data-tab="${tabId}"]`).classList.add('active');

            // Activate listeners for the current tab
            if (tabId === 'live') initLiveMonitorTab();
            if (tabId === 'pelanggaran') initPelanggaranTab();
            if (tabId === 'analisis') initAnalisisTab();
            if (tabId === 'pengaturan') initPengaturanTab(); // Init new tab
        }

        // --- Tab 1: Monitor Sesi Live ---
        function initLiveMonitorTab() {
            monitorSession(currentLiveSession);
        }

        document.getElementById('reset-session-btn').addEventListener('click', () => {
            showConfirmation(`Anda yakin ingin mereset semua data Sesi Pengerjaan Kuis? Tindakan ini tidak dapat dibatalkan.`, async () => {
                const snapshot = await db.collection(currentLiveSession).get();
                const batch = db.batch();
                snapshot.docs.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
            });
        });
        
        function monitorSession(collectionName) {
            liveSessionUnsubscribe = db.collection(collectionName).onSnapshot(snapshot => {
                document.getElementById('student-count').textContent = snapshot.size;
                const studentList = document.getElementById('student-list');
                studentList.innerHTML = '';
                if (snapshot.empty) {
                    studentList.innerHTML = `<p class="text-center text-gray-500">Belum ada murid yang memulai kuis.</p>`;
                }
                const students = [];
                snapshot.forEach(doc => students.push(doc.data()));
                students.sort((a,b) => a.name.localeCompare(b.name)); // Sort alphabetically

                students.forEach(student => {
                    const statusClass = student.status === 'Beralih Tab' ? 'text-red-500 font-bold status-cheating' : 'text-green-500';
                    const studentHtml = `
                        <div class="bg-white p-4 rounded-lg shadow-sm border flex justify-between items-center">
                            <div>
                                <p class="font-semibold text-gray-800">${student.name}</p>
                                <p class="text-sm text-gray-500">${student.class}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm">Progres: <span class="font-semibold">${student.progress}</span></p>
                                <p class="text-sm">Status: <span class="${statusClass}">${student.status}</span></p>
                            </div>
                        </div>
                    `;
                    studentList.innerHTML += studentHtml;
                });
            }, (error) => {
                console.error("Firestore listener error:", error);
                if (error.code === 'permission-denied') {
                    securityErrorModal.classList.remove('hidden');
                } else {
                    document.getElementById('student-list').innerHTML = `<p class="text-center text-red-500">Gagal terhubung ke Firestore. Periksa koneksi internet Anda.</p>`;
                }
            });
        }

        // --- Tab 2: Riwayat Pelanggaran ---
        document.getElementById('delete-all-logs-btn').addEventListener('click', () => {
            showConfirmation('Anda yakin ingin menghapus semua riwayat pelanggaran?', async () => {
                const snapshot = await db.collection('cheating_log').get();
                const batch = db.batch();
                snapshot.docs.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
            });
        });

        function initPelanggaranTab() {
            const logList = document.getElementById('cheating-log-list');
            cheatingLogUnsubscribe = db.collection('cheating_log').orderBy('timestamp', 'desc').onSnapshot(snapshot => {
                logList.innerHTML = '';
                 if (snapshot.empty) {
                    logList.innerHTML = `<p class="text-center text-gray-500">Tidak ada riwayat pelanggaran.</p>`;
                }
                snapshot.forEach(doc => {
                    const log = doc.data();
                    const logTime = new Date(log.timestamp.seconds * 1000).toLocaleString('id-ID');
                    const logHtml = `
                        <div class="group bg-white p-4 rounded-lg shadow-sm border flex justify-between items-center">
                            <div>
                                <p class="font-semibold text-gray-800">${log.name} <span class="font-normal text-gray-500">- ${log.class}</span></p>
                                <p class="text-sm text-gray-500">Sesi Pengerjaan Kuis | Waktu: ${logTime}</p>
                            </div>
                            <button data-id="${doc.id}" class="delete-log-btn delete-btn text-red-500 hover:text-red-700 p-2 rounded-full">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    `;
                    logList.innerHTML += logHtml;
                });
            }, (error) => {
                console.error("Firestore listener error:", error);
                 if (error.code === 'permission-denied') {
                    securityErrorModal.classList.remove('hidden');
                } else {
                    logList.innerHTML = `<p class="text-center text-red-500">Gagal memuat riwayat pelanggaran.</p>`;
                }
            });
        }
        
        document.getElementById('cheating-log-list').addEventListener('click', e => {
            const deleteBtn = e.target.closest('.delete-log-btn');
            if (deleteBtn) {
                const docId = deleteBtn.dataset.id;
                showConfirmation('Hapus log ini?', () => {
                    db.collection('cheating_log').doc(docId).delete();
                });
            }
        });

        // --- Tab 3: Analisis Jawaban ---
        const analysisExamType = document.getElementById('analysis-exam-type');
        const analysisClass = document.getElementById('analysis-class');
        const analysisOptions = document.getElementById('analysis-options');
        const analysisResultsArea = document.getElementById('analysis-results-area');
        const analysisLoading = document.getElementById('analysis-loading');
        const classAnalysisContent = document.getElementById('class-analysis-content');
        const studentAnalysisContent = document.getElementById('student-analysis-content');
        const studentInfoArea = document.getElementById('student-info-area');
        const resetAttemptBtn = document.getElementById('reset-attempt-btn');
        const resetStatus = document.getElementById('reset-status');

        function initAnalisisTab() {
            analysisExamType.value = '';
            analysisClass.innerHTML = '<option value="">-- Pilih Tipe Jawaban Dulu --</option>';
            analysisClass.disabled = true;
            analysisOptions.classList.add('hidden');
            analysisResultsArea.classList.add('hidden');
        }

        analysisExamType.addEventListener('change', async (e) => {
            const type = e.target.value;
            analysisResultsArea.classList.add('hidden');
            classAnalysisContent.classList.add('hidden');
            studentAnalysisContent.classList.add('hidden');
            studentInfoArea.classList.add('hidden'); // Sembunyikan info siswa

            if (!type) {
                 analysisClass.disabled = true;
                 analysisOptions.classList.add('hidden');
                 return;
            }

            analysisLoading.classList.remove('hidden'); // Show loading indicator
            
            // Pilih data yang sudah di-preload
            analysisData.answers = (type === 'pilihan_ganda') ? analysisData.pgAnswers : analysisData.uraianAnswers;
            
            document.getElementById('analyze-class-btn').disabled = (type === 'uraian');
            document.getElementById('ai-summary-btn').classList.toggle('hidden', type !== 'pilihan_ganda'); // Hide AI summary for uraian
            
            const classes = [...new Set(analysisData.answers.map(a => a.Kelas))].sort();
            analysisClass.innerHTML = '<option value="">-- Pilih Kelas --</option>';
            classes.forEach(c => {
                analysisClass.innerHTML += `<option value="${c}">${c}</option>`;
            });
            analysisClass.disabled = false;
            analysisLoading.classList.add('hidden'); // Hide loading indicator
        });

        analysisClass.addEventListener('change', async (e) => {
            const className = e.target.value;
            analysisResultsArea.classList.add('hidden'); // Sembunyikan hasil saat kelas berubah
            studentInfoArea.classList.add('hidden'); // Sembunyikan info siswa

            if (!className) {
                analysisOptions.classList.add('hidden');
                return;
            }
            analysisOptions.classList.remove('hidden');
            analysisLoading.classList.remove('hidden'); // Show loading

            let questionUrl = '';
            if (className.startsWith('Kelas X')) questionUrl = CSV_URLS.soalX;
            else if (className.startsWith('Kelas XI')) questionUrl = CSV_URLS.soalXI;
            else if (className.startsWith('Kelas XII')) questionUrl = CSV_URLS.soalXII;

            try {
                const response = await fetch(questionUrl);
                const text = await response.text();
                analysisData.questions = parseCSV(text);
            } catch (err) {
                 alert('Gagal memuat bank soal.');
            } finally {
                analysisLoading.classList.add('hidden'); // Hide loading
            }
        });
        
        document.getElementById('analyze-class-btn').addEventListener('click', renderClassAnalysis);
        document.getElementById('analyze-student-btn').addEventListener('click', showStudentAnalysisSelection);

        function renderClassAnalysis() {
            analysisResultsArea.classList.remove('hidden');
            studentAnalysisContent.classList.add('hidden');
            studentInfoArea.classList.add('hidden'); // Sembunyikan info siswa
            classAnalysisContent.classList.remove('hidden');
            document.getElementById('ai-summary-result').classList.add('hidden');

            const selectedClass = analysisClass.value;
            const classAnswers = analysisData.answers.filter(a => a.Kelas === selectedClass);
            const totalStudents = new Set(classAnswers.map(a => a.Nama)).size;
            const totalScore = classAnswers.reduce((sum, a) => sum + parseFloat(a.Skor || 0), 0);
            const avgScore = totalStudents > 0 ? (totalScore / totalStudents) : 0;
            
            document.getElementById('class-stats').innerHTML = `
                <div class="bg-slate-100 p-4 rounded-lg"><p class="text-sm text-gray-600">Jumlah Peserta</p><p class="text-2xl font-bold">${totalStudents}</p></div>
                <div class="bg-slate-100 p-4 rounded-lg"><p class="text-sm text-gray-600">Rata-rata Skor</p><p class="text-2xl font-bold">${avgScore.toFixed(1)}</p></div>
            `;
            
            const questionList = document.getElementById('question-analysis-list');
            questionList.innerHTML = '';
            analysisData.questions.forEach(q => {
                const questionNum = q.No;
                if (q['Jenis Soal'] === 'Uraian') return; // Skip essay questions for this analysis

                // Placeholder logic for correctness as the CSV doesn't have per-question data
                const studentCount = totalStudents;
                const correctCount = Math.floor(Math.random() * (studentCount + 1)); 
                const correctness = studentCount > 0 ? (correctCount / studentCount) * 100 : 0;
                
                const key = q[`Opsi ${q['Kunci Jawaban']}`];

                questionList.innerHTML += `
                    <div class="border rounded-lg p-4">
                        <p class="text-sm font-semibold text-gray-600">Soal No. ${q.No}: <span class="font-normal">${q.Soal}</span></p>
                        <p class="text-sm text-green-600 mt-1">Kunci Jawaban: ${key || 'N/A'}</p>
                        <div class="mt-2">
                            <div class="flex justify-between items-center text-sm">
                                <p>Tingkat Kebenaran (Estimasi)</p>
                                <p class="font-semibold">${correctness.toFixed(1)}%</p>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5 mt-1">
                                <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${correctness}%"></div>
                            </div>
                            <details class="mt-2 text-sm">
                                <summary class="cursor-pointer text-blue-600">${correctCount} dari ${studentCount} murid menjawab benar (estimasi)</summary>
                                <div class="p-2 bg-slate-50 rounded mt-1">
                                    <p>Data per murid tidak tersedia di file CSV.</p>
                                </div>
                            </details>
                        </div>
                    </div>
                `;
            });
        }

        function showStudentAnalysisSelection() {
            analysisResultsArea.classList.remove('hidden');
            classAnalysisContent.classList.add('hidden');
            studentAnalysisContent.classList.remove('hidden');
            document.getElementById('student-detail-list').innerHTML = ''; // Clear previous details
            studentInfoArea.classList.add('hidden'); // Sembunyikan info siswa awal

            const selectedClass = analysisClass.value;
            const studentsInClass = [...new Set(analysisData.answers.filter(a => a.Kelas === selectedClass).map(a => a.Nama))].sort();
            const studentSelect = document.getElementById('analysis-student');
            studentSelect.innerHTML = '<option value="">-- Pilih Murid --</option>';
            studentsInClass.forEach(name => {
                studentSelect.innerHTML += `<option value="${name}">${name}</option>`;
            });
        }
        
        document.getElementById('show-student-analysis-btn').addEventListener('click', () => {
             const studentName = document.getElementById('analysis-student').value;
             if (!studentName) return;

             const selectedClass = analysisClass.value; // Dapatkan kelas yang dipilih
             const studentId = `${selectedClass}_${studentName}`.replace(/\s+/g, '_'); // Bentuk ID Firestore
             
             const examType = analysisExamType.value;
             // Gunakan data PG yang sudah di-preload untuk menghitung percobaan
             const studentAttemptsCount = analysisData.pgAnswers.filter(a => a.Nama === studentName && a.Kelas === selectedClass).length; 

             // Tampilkan info jumlah percobaan dan tombol reset
             studentInfoArea.classList.remove('hidden');
             document.getElementById('student-attempt-count').textContent = studentAttemptsCount;
             resetAttemptBtn.dataset.studentid = studentId; // Simpan ID di tombol
             resetStatus.textContent = ''; // Kosongkan status reset
             
             const studentAttempts = analysisData.answers.filter(a => a.Nama === studentName);
             if (studentAttempts.length === 0) return;
             
             const latestAttempt = studentAttempts[studentAttempts.length - 1]; // Find the last attempt
             const detailList = document.getElementById('student-detail-list');
             detailList.innerHTML = `<h4 class="text-lg font-semibold text-gray-800 mb-4 text-center">Analisis Jawaban: ${studentName}</h4>`;
             
             if (examType === 'pilihan_ganda') {
                 analysisData.questions.forEach(q => {
                     if (q['Jenis Soal'] === 'Uraian') return;
                     // Placeholder logic, ideally needs per-question results from student data
                     const isCorrect = Math.random() > 0.5; 
                     const studentAnswer = q[`Opsi ${isCorrect ? q['Kunci Jawaban'] : 'A'}`]; 
                     const key = q[`Opsi ${q['Kunci Jawaban']}`];
                     
                     detailList.innerHTML += `
                        <div class="border rounded-lg p-4 mb-3">
                             <p class="text-sm font-semibold text-gray-600">Soal No. ${q.No}: <span class="font-normal">${q.Soal}</span></p>
                             <p class="mt-2 text-sm">Jawaban Murid (Estimasi): <span class="font-semibold ${isCorrect ? 'text-green-600' : 'text-red-600'}">${studentAnswer} (${isCorrect ? 'Benar' : 'Salah'})</span></p>
                             ${!isCorrect ? `<p class="text-sm mt-1">Jawaban Benar: <span class="font-semibold text-green-600">${key || 'N/A'}</span></p>` : ''}
                        </div>
                     `;
                 });
             } else if (examType === 'uraian') {
                if (!latestAttempt || !latestAttempt.Jawaban) {
                    detailList.innerHTML += `<p class="text-center text-gray-500">Tidak ditemukan data jawaban uraian untuk murid ini.</p>`;
                    return;
                }
                let uraianAnswers = [];
                try {
                     uraianAnswers = JSON.parse(latestAttempt.Jawaban); // Parse the JSON string
                } catch(e) {
                     console.error("Gagal parse jawaban uraian JSON:", e, latestAttempt.Jawaban);
                     detailList.innerHTML += `<p class="text-center text-red-500">Format data jawaban uraian tidak valid.</p>`;
                     return;
                }
                
                analysisData.questions.forEach(q => {
                    if (q['Jenis Soal'] !== 'Uraian') return;
                    const studentAnswerObj = uraianAnswers.find(ans => ans.no == q.No); // Use == for potential type mismatch
                    const studentAnswerText = studentAnswerObj ? studentAnswerObj.answer : 'Tidak menjawab';
                    const analysisResultId = `ai-result-${q.No}-${studentName.replace(/\s+/g, '-')}`;

                    detailList.innerHTML += `
                        <div class="border rounded-lg p-4 mb-3">
                            <p class="text-sm font-semibold text-gray-600">Soal No. ${q.No}: <span class="font-normal">${q.Soal}</span></p>
                            <p class="mt-2 text-sm">Jawaban Murid:</p>
                            <div class="p-2 bg-slate-50 rounded mt-1 text-sm text-gray-700 whitespace-pre-wrap">${studentAnswerText || '<i>Tidak ada jawaban</i>'}</div>
                            <div class="mt-3 text-right">
                                <button class="analyze-essay-btn bg-gradient-to-r from-teal-400 to-blue-500 text-white font-semibold py-1 px-3 rounded-lg hover:opacity-90 transition text-sm flex items-center gap-1 inline-flex" 
                                        data-question="${q.Soal}" data-answer="${studentAnswerText || ''}" data-qnum="${q.No}" data-result-id="${analysisResultId}">
                                    âœ¨ Analisis AI
                                </button>
                            </div>
                            <div id="${analysisResultId}" class="ai-analysis-result hidden mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm prose"></div>
                        </div>
                    `;
                });
             }
        });
        
        // --- Reset Attempt Logic ---
        resetAttemptBtn.addEventListener('click', async (e) => {
             const studentDocId = e.target.dataset.studentid;
             const studentName = document.getElementById('analysis-student').value;
             if (!studentDocId) return;

             showConfirmation(`Anda yakin ingin mereset percobaan kuis untuk ${studentName}? Murid ini akan bisa mengerjakan kuis lagi.`, async () => {
                 resetStatus.textContent = 'Mereset...';
                 resetStatus.classList.remove('text-green-600', 'text-red-600');
                 resetStatus.classList.add('text-gray-500');
                 try {
                     await db.collection('quiz_attempts').doc(studentDocId).delete();
                     resetStatus.textContent = `Percobaan untuk ${studentName} berhasil direset.`;
                     resetStatus.classList.remove('text-gray-500');
                     resetStatus.classList.add('text-green-600');
                     // Update attempt count display (optional, requires re-query or local update)
                     document.getElementById('student-attempt-count').textContent = '0 (Telah Direset)';
                 } catch (error) {
                     console.error("Gagal mereset percobaan:", error);
                     resetStatus.textContent = 'Gagal mereset percobaan.';
                     resetStatus.classList.remove('text-gray-500');
                     resetStatus.classList.add('text-red-600');
                 }
             });
        });

        // --- AI Analysis for Essay ---
        async function analyzeEssayAnswer(btn, questionText, studentAnswer, questionNumber, resultDivId) {
             const resultDiv = document.getElementById(resultDivId);
             btn.disabled = true;
             btn.innerHTML = '<div class="loader ai-loader"></div> Menganalisis...';
             resultDiv.classList.remove('hidden');
             resultDiv.innerHTML = '<div class="loader ai-loader mx-auto"></div>';

             const systemPrompt = "Anda adalah seorang guru penilai. Berdasarkan soal berikut dan jawaban siswa, berikan evaluasi singkat mengenai pemahaman siswa, keakuratan jawaban, dan kejelasan penyampaian. Berikan juga saran skor (misal: 7/10). Analisis harus dalam Bahasa Indonesia.";
             const userQuery = `Soal (No. ${questionNumber}): ${questionText}\n\nJawaban Siswa: ${studentAnswer}`;
             const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
             const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] } };

             try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                 if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                     const text = result.candidates[0].content.parts[0].text;
                     resultDiv.innerHTML = text.replace(/(\* |- )/g, '<br>â€¢ ').replace(/\n/g, '<br>');
                } else {
                     throw new Error("Respons AI tidak valid atau kosong.");
                }
            } catch (err) {
                console.error("AI Essay Analysis Error:", err);
                resultDiv.innerHTML = `<p class="text-red-500">Gagal mendapatkan analisis dari AI. ${err.message}</p>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'âœ¨ Analisis AI';
            }
        }
        
        // Event delegation for essay analysis buttons
        document.getElementById('student-detail-list').addEventListener('click', (e) => {
            const button = e.target.closest('.analyze-essay-btn');
            if (button) {
                analyzeEssayAnswer(
                    button,
                    button.dataset.question,
                    button.dataset.answer,
                    button.dataset.qnum,
                    button.dataset.resultId
                );
            }
        });

        document.getElementById('ai-summary-btn').addEventListener('click', async (e) => {
            const btn = e.currentTarget;
            btn.disabled = true;
            btn.innerHTML = '<div class="loader ai-loader"></div> Menganalisis...';
            
            const hardestQuestions = Array.from(document.getElementById('question-analysis-list').children)
                .map(el => {
                    const text = el.querySelector('p:first-child').textContent;
                    const correctness = el.querySelector('.flex p:last-child').textContent;
                    return { text, correctness };
                })
                .sort((a,b) => parseFloat(a.correctness) - parseFloat(b.correctness))
                .slice(0, 5)
                .map(q => `- ${q.text} (Tingkat Kebenaran: ${q.correctness})`)
                .join('\n');

            const systemPrompt = "Anda adalah seorang analis pendidikan. Berdasarkan data 5 soal tersulit berikut, berikan evaluasi singkat mengenai kemungkinan penyebab kesulitan siswa dan berikan 2-3 rekomendasi tindakan perbaikan bagi guru. Sajikan dalam format poin-poin. Gunakan Bahasa Indonesia.";
            const userQuery = `Berikut adalah 5 soal tersulit:\n${hardestQuestions}`;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
            const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] } };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                 if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                 if (!result.candidates || result.candidates.length === 0 || !result.candidates[0].content || !result.candidates[0].content.parts || result.candidates[0].content.parts.length === 0) {
                     throw new Error("Respons AI tidak valid atau kosong.");
                 }
                const text = result.candidates[0].content.parts[0].text;
                const resultDiv = document.getElementById('ai-summary-result');
                resultDiv.innerHTML = text.replace(/(\* |- )/g, '<br>â€¢ ').replace(/\n/g, '<br>');
                resultDiv.classList.remove('hidden');
            } catch (err) {
                console.error("AI Summary Error:", err);
                alert('Gagal mendapatkan ringkasan dari AI. Periksa API Key Anda atau lihat console untuk detail error.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'âœ¨ Buat Ringkasan AI';
            }
        });
        
        // --- Tab 4: Pengaturan Kuis ---
        function initPengaturanTab() {
            configClassLevelSelect.value = ''; // Reset dropdown kelas
            configForm.classList.add('hidden'); // Sembunyikan form awal
            configSaveStatus.textContent = ''; // Kosongkan status simpan
        }
        
        configClassLevelSelect.addEventListener('change', async (e) => {
            const classLevel = e.target.value;
            configSaveStatus.textContent = ''; // Kosongkan status saat ganti kelas
            if (!classLevel) {
                configForm.classList.add('hidden');
                configLoader.classList.add('hidden');
                return;
            }

            configForm.classList.add('hidden');
            configLoader.classList.remove('hidden');

            try {
                const docRef = db.collection('quiz_configs').doc(classLevel);
                const docSnap = await docRef.get();

                if (docSnap.exists) {
                    const data = docSnap.data();
                    configNumQuestionsInput.value = data.numQuestions || '';
                    configShuffleCheckbox.checked = data.shuffle || false;
                    configUseTimerCheckbox.checked = data.useTimer || false;
                    configTimerDurationInput.value = data.timerDuration || '';
                    configTimerDurationGroup.classList.toggle('hidden', !data.useTimer);
                } else {
                    // Default values if no config exists
                    configNumQuestionsInput.value = '';
                    configShuffleCheckbox.checked = false;
                    configUseTimerCheckbox.checked = false;
                    configTimerDurationInput.value = '';
                    configTimerDurationGroup.classList.add('hidden');
                }
                configForm.classList.remove('hidden');
            } catch (error) {
                 console.error("Error loading config:", error);
                 configSaveStatus.textContent = 'Gagal memuat pengaturan.';
                 configSaveStatus.classList.remove('text-green-600');
                 configSaveStatus.classList.add('text-red-600');
            } finally {
                configLoader.classList.add('hidden');
            }
        });
        
         configUseTimerCheckbox.addEventListener('change', (e) => {
             configTimerDurationGroup.classList.toggle('hidden', !e.target.checked);
             if (!e.target.checked) {
                 configTimerDurationInput.value = ''; // Kosongkan durasi jika timer tidak aktif
             }
         });

         saveConfigBtn.addEventListener('click', async (e) => {
             const btn = e.currentTarget;
             btn.disabled = true;
             btn.innerHTML = '<div class="loader ai-loader"></div> Menyimpan...';
             configSaveStatus.textContent = '';

             const classLevel = configClassLevelSelect.value;
             if (!classLevel) return;

             const numQuestions = configNumQuestionsInput.value ? parseInt(configNumQuestionsInput.value) : null;
             const shuffle = configShuffleCheckbox.checked;
             const useTimer = configUseTimerCheckbox.checked;
             const timerDuration = useTimer && configTimerDurationInput.value ? parseInt(configTimerDurationInput.value) : null;

             const configData = {
                 numQuestions: numQuestions,
                 shuffle: shuffle,
                 useTimer: useTimer,
                 timerDuration: timerDuration
             };

             try {
                 await db.collection('quiz_configs').doc(classLevel).set(configData);
                 configSaveStatus.textContent = 'Pengaturan berhasil disimpan!';
                 configSaveStatus.classList.remove('text-red-600');
                 configSaveStatus.classList.add('text-green-600');
             } catch (error) {
                 console.error("Error saving config:", error);
                 configSaveStatus.textContent = 'Gagal menyimpan pengaturan.';
                 configSaveStatus.classList.remove('text-green-600');
                 configSaveStatus.classList.add('text-red-600');
                  if (error.code === 'permission-denied') {
                    securityErrorModal.classList.remove('hidden');
                 }
             } finally {
                 btn.disabled = false;
                 btn.innerHTML = 'Simpan Pengaturan';
             }
         });


        // --- Global Listeners ---
        document.getElementById('confirm-no-btn').addEventListener('click', () => {
            confirmationModal.classList.add('hidden');
            confirmCallback = null;
        });
        document.getElementById('confirm-yes-btn').addEventListener('click', () => {
            if (confirmCallback) confirmCallback();
            confirmationModal.classList.add('hidden');
            confirmCallback = null;
        });
        document.getElementById('security-close-btn').addEventListener('click', () => {
             securityErrorModal.classList.add('hidden');
        });

        // --- Init App ---
        async function initializeApp() {
            // Cek Firebase config placeholder sebelum init
             if (!firebaseConfig || firebaseConfig.apiKey.startsWith("AIzaSy...")) {
                 document.getElementById('login-modal').classList.add('hidden');
                 configErrorModal.classList.remove('hidden');
                 return;
             }

            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                await firebase.auth().signInAnonymously();
                console.log("Firebase Authenticated Anonymously");
                initLogin();
            } catch(e) {
                console.error("Firebase Initialization Error:", e);
                if (e.code === 'permission-denied') {
                    securityErrorModal.classList.remove('hidden');
                } else {
                     document.body.innerHTML = `<div class="p-8 text-center text-red-600">Gagal menginisialisasi aplikasi. Periksa konfigurasi Firebase Anda.<br><small>${e.message}</small></div>`;
                }
            }
        }

        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>
</body>
</html>

